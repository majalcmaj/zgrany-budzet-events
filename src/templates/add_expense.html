{% extends "base.html" %}

{% block title %}Dodaj Wydatek{% endblock %}
{% block content %}
<h1>Dodaj Wydatek</h1>

<form method="POST" class="needs-validation" novalidate>
    <!-- Basic Information -->
    <fieldset>
        <legend>Informacje podstawowe</legend>

        <label for="dzial">
            Dział <span style="color: red;">*</span>
            <select id="dzial" name="dzial" required title="Wybierz dział budżetowy">
                <option value="" selected disabled>Wybierz dział</option>
            </select>
            <div class="invalid-feedback">
                Wybierz dział budżetowy
            </div>
        </label>

        <label for="chapter">
            Rozdział <span style="color: red;">*</span>
            <select id="chapter" name="chapter" required title="Wybierz rozdział budżetowy">
                <option value="" selected disabled>Wybierz rozdział</option>
            </select>
            <div class="invalid-feedback">
                Wybierz rozdział budżetowy
            </div>
        </label>

        <label for="departament">
            Departament <span style="color: red;">*</span>
            <input type="text" id="departament" name="departament" placeholder="Np. BA" required
                title="Podaj kod departamentu">
            <div class="invalid-feedback">
                Podaj kod departamentu
            </div>
        </label>

        <label for="task_name">
            Nazwa zadania <span style="color: red;">*</span>
            <input type="text" id="task_name" name="task_name" placeholder="Np. Zakup materiałów biurowych" required
                title="Wpisz krótką, opisową nazwę zadania">
            <div class="invalid-feedback">
                Wpisz krótką, opisową nazwę zadania
            </div>
        </label>

        <label for="opis_projektu">
            Opis projektu <span style="color: red;">*</span>
            <textarea id="opis_projektu" name="opis_projektu" rows="3" placeholder="Szczegółowy opis projektu" required
                title="Podaj szczegółowy opis projektu"></textarea>
            <div class="invalid-feedback">
                Podaj szczegółowy opis projektu
            </div>
        </label>

        <label for="termin_realizacji">
            Termin realizacji <span style="color: red;">*</span>
            <input type="text" id="termin_realizacji" name="termin_realizacji" placeholder="Np. 24 miesiące" required
                title="Podaj termin realizacji projektu">
            <div class="invalid-feedback">
                Podaj termin realizacji projektu
            </div>
        </label>
    </fieldset>

    <script>
        // Load classification data
        fetch('/expenses/api/classifications')
            .then(response => response.json())
            .then(data => {
                const dzialSelect = document.getElementById('dzial');
                const chapterSelect = document.getElementById('chapter');

                // Populate działów
                Object.entries(data.dzialy).forEach(([code, name]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = `${code}: ${name}`;
                    dzialSelect.appendChild(option);
                });

                // Store data for filtering
                window.rozdzialy = data.rozdzialy;
                window.dzialRozdzialMapping = data.dzial_rozdzial_mapping;

                // Update rozdziały when dział changes
                dzialSelect.addEventListener('change', function () {
                    const selectedDzial = this.value;
                    chapterSelect.innerHTML = '<option value="" selected disabled>Wybierz rozdział</option>';

                    if (selectedDzial && window.dzialRozdzialMapping[selectedDzial]) {
                        window.dzialRozdzialMapping[selectedDzial].forEach(rozdzialCode => {
                            const rozdzialName = window.rozdzialy[rozdzialCode];
                            if (rozdzialName) {
                                const option = document.createElement('option');
                                option.value = rozdzialCode;
                                option.textContent = `${rozdzialCode}: ${rozdzialName}`;
                                chapterSelect.appendChild(option);
                            }
                        });
                    }
                });
            });
    </script>

    <!-- Budget (5 years) -->
    <fieldset>
        <legend>Budżet (tys. zł)</legend>

        <div class="grid">
            <label for="budget_2025">
                2025 <span style="color: red;">*</span>
                <input type="number" id="budget_2025" name="budget_2025" placeholder="0" min="0" step="1" required
                    title="Podaj kwotę w tysiącach złotych dla roku 2025">
                <div class="invalid-feedback">
                    Podaj kwotę w tysiącach złotych dla roku 2025
                </div>
            </label>

            <label for="budget_2026">
                2026 <span style="color: red;">*</span>
                <input type="number" id="budget_2026" name="budget_2026" placeholder="0" min="0" step="1" required
                    title="Podaj kwotę w tysiącach złotych dla roku 2026">
                <div class="invalid-feedback">
                    Podaj kwotę w tysiącach złotych dla roku 2026
                </div>
            </label>

            <label for="budget_2027">
                2027 <span style="color: red;">*</span>
                <input type="number" id="budget_2027" name="budget_2027" placeholder="0" min="0" step="1" required
                    title="Podaj kwotę w tysiącach złotych dla roku 2027">
                <div class="invalid-feedback">
                    Podaj kwotę w tysiącach złotych dla roku 2027
                </div>
            </label>

            <label for="budget_2028">
                2028 <span style="color: red;">*</span>
                <input type="number" id="budget_2028" name="budget_2028" placeholder="0" min="0" step="1" required
                    title="Podaj kwotę w tysiącach złotych dla roku 2028">
                <div class="invalid-feedback">
                    Podaj kwotę w tysiącach złotych dla roku 2028
                </div>
            </label>

            <label for="budget_2029">
                2029 <span style="color: red;">*</span>
                <input type="number" id="budget_2029" name="budget_2029" placeholder="0" min="0" step="1" required
                    title="Podaj kwotę w tysiącach złotych dla roku 2029">
                <div class="invalid-feedback">
                    Podaj kwotę w tysiącach złotych dla roku 2029
                </div>
            </label>
        </div>
    </fieldset>

    <!-- Contract Number -->
    <fieldset>
        <legend>Informacje o umowie</legend>

        <label for="nr_umowy">
            Numer umowy <span style="color: red;">*</span>
            <input type="text" id="nr_umowy" name="nr_umowy" placeholder="Np. 80/BA/24" required
                title="Podaj numer umowy">
            <div class="invalid-feedback">
                Podaj numer umowy
            </div>
        </label>
    </fieldset>

    <div class="grid">
        <button role="accept" type="submit">Dodaj</button>
        <button role="reject" type="button" onclick="window.history.back()">Anuluj</button>
    </div>
</form>

{% endblock %}