{% extends "base.html" %}

{% block title %}Lista Wydatków{% endblock %}

{% import "icons.html" as icons %}
{% block content %}
<h1 class="header-with-icon">{{ icons.icon_role_office(width=48, height=48) }} Panel {{
    offices_genitive[session['role']] }} - Lista Wydatków</h1>
<div style="overflow-x: auto; overflow-y: visible; scrollbar-width: auto; scrollbar-color: #888 #f1f1f1;">
    <style>
        /* Custom scrollbar for webkit browsers */
        div[style*="overflow-x: auto"]::-webkit-scrollbar {
            height: 16px;
        }

        div[style*="overflow-x: auto"]::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 8px;
        }

        div[style*="overflow-x: auto"]::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 8px;
        }

        div[style*="overflow-x: auto"]::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Column width constraints and text handling */
        .expenses-table {
            border-collapse: collapse;
        }

        .expenses-table th,
        .expenses-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .expenses-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            border-bottom: 2px solid #888;
        }

        .expenses-table td:nth-child(1),
        .expenses-table th:nth-child(1) {
            /* Rozdział */
            min-width: 80px;
            max-width: 100px;
        }

        .expenses-table td:nth-child(2),
        .expenses-table th:nth-child(2) {
            /* Departament */
            min-width: 100px;
            max-width: 120px;
        }

        .expenses-table td:nth-child(3),
        .expenses-table th:nth-child(3) {
            /* Nazwa zadania */
            min-width: 200px;
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
        }

        .expenses-table td:nth-child(4),
        .expenses-table th:nth-child(4) {
            /* Opis projektu */
            min-width: 200px;
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
        }

        .expenses-table td:nth-child(5),
        .expenses-table th:nth-child(5) {
            /* Termin realizacji */
            min-width: 120px;
            max-width: 150px;
        }

        .expenses-table td:nth-child(6),
        .expenses-table th:nth-child(6),
        .expenses-table td:nth-child(7),
        .expenses-table th:nth-child(7),
        .expenses-table td:nth-child(8),
        .expenses-table th:nth-child(8),
        .expenses-table td:nth-child(9),
        .expenses-table th:nth-child(9),
        .expenses-table td:nth-child(10),
        .expenses-table th:nth-child(10) {
            /* Budget years */
            min-width: 80px;
            max-width: 100px;
            text-align: right;
        }

        .expenses-table td:nth-child(11),
        .expenses-table th:nth-child(11) {
            /* Nr umowy */
            min-width: 120px;
            max-width: 150px;
        }
    </style>
    <figure>
        <table role="grid" class="expenses-table">
            <thead>
                <tr>
                    <th scope="col">Rozdział</th>
                    <th scope="col">Departament</th>
                    <th scope="col">Nazwa zadania</th>
                    <th scope="col">Opis projektu</th>
                    <th scope="col">Termin realizacji</th>
                    <th scope="col">2025</th>
                    <th scope="col">2026</th>
                    <th scope="col">2027</th>
                    <th scope="col">2028</th>
                    <th scope="col">2029</th>
                    <th scope="col">Nr umowy</th>
                </tr>
            </thead>
            <tbody>
                {% if not expenses %}
                <tr>
                    <td colspan="11">Brak wydatków</td>
                </tr>
                {% else %}
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense.chapter }}</td>
                    <td>{{ expense.departament or '-' }}</td>
                    <td>{{ expense.task_name }}</td>
                    <td>{{ expense.opis_projektu or '-' }}</td>
                    <td>{{ expense.termin_realizacji or '-' }}</td>
                    <td>{{ expense.budget_2025 or '-' }}</td>
                    <td>{{ expense.budget_2026 or '-' }}</td>
                    <td>{{ expense.budget_2027 or '-' }}</td>
                    <td>{{ expense.budget_2028 or '-' }}</td>
                    <td>{{ expense.budget_2029 or '-' }}</td>
                    <td>{{ expense.nr_umowy or '-' }}</td>
                </tr>
                {% endfor %}
                {% endif %}
            </tbody>
            {% if expenses_sum %}
            <tfoot>
                <tr>
                    <td colspan="6">Suma (2026)</td>
                    <td>{{ expenses_sum }} tys. zł</td>
                    <td colspan="4"></td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </figure>
</div>
{% if state.status == PlanningStatus.NOT_STARTED %}
<article>
    <header style="font-weight: bold;">Proces planowania nie został otwarty</header>
    Administracja musi otworzyć proces planowania, zanim będzie można dodawać wydatki.
</article>
{% elif state.status == PlanningStatus.IN_REVIEW %}
<article>
    <header style="font-weight: bold; color: green; align-items: center; gap: 0.5rem; background: none;">
        Wysłane {{ icons.icon_planning_in_review() }}
    </header>
    Proces jest w trakcie przeglądu przez Ministerstwo. Nie można dodawać nowych wydatków.
</article>
{% elif closed %}
<article>
    <header style="font-weight: bold; color: green; align-items: center; gap: 0.5rem; background: none;">
        Wysłane {{ icons.icon_office_submitted() }}
    </header>
    Lista jest zamknięta. Nie można dodawać nowych wydatków.
</article>
{% else %}
<div class="grid">
    <div>
        <a href="/expenses/add" role="button" style="width: 100%;">Dodaj nowy wydatek</a>
    </div>
    <div>
        <form action="/expenses/close" method="POST" style="display: inline;">
            <button type="submit" role="accept" class="secondary">Wyślij do akceptacji</button>
        </form>
    </div>
</div>

<article>
    <header>Import z pliku</header>
    <form action="/expenses/import" method="POST" class="needs-validation" novalidate>
        <div class="grid">
            <div class="file-input-wrapper" style="display: flex; align-items: center; gap: 1rem; position: relative;">
                <input type="file" id="file-import" name="file" required class="file-input"
                    title="Wybierz plik do importu"
                    onchange="document.getElementById('file-name').textContent = this.files[0] ? this.files[0].name : 'Brak wybranego pliku'"
                    style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;">
                <label for="file-import" class="secondary" role="button" style="margin-bottom: 0;">Wybierz plik</label>
                <span id="file-name" style="font-style: italic;">Brak wybranego pliku</span>
                <div class="invalid-feedback" style="top: 100%; margin-top: 0.5rem;">
                    Wybierz plik do importu
                </div>
            </div>
            <button type="submit" class="secondary">Pobierz dane z pliku</button>
        </div>
    </form>
</article>

{% endif %}
{% endblock %}