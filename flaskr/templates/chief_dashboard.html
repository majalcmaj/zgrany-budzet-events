{% extends "base.html" %}
{% import "icons.html" as icons %}

{% block title %}Panel Administracyjny{% endblock %}

{% block content %}
<h1 class="header-with-icon">{{ icons.icon_role_chief(width=48, height=48) }} Panel Administracji - Planowanie Budżetu
    na lata {{ state.planning_year }}-{{ state.planning_year + 4 }}
</h1>

<article>
    {% if state.status == PlanningStatus.NOT_STARTED %}
    <strong style="color: gray; display: inline-flex; align-items: center; gap: 0.5rem;">
        {{ icons.icon_planning_not_started() }}
        PLANOWANIE NIE ROZPOCZĘTE
    </strong>
    <hr />
    <form method="POST" class="grid needs-validation" novalidate>
        <label for="deadline">Ustaw termin <span style="color: red;">*</span></label>
        <div style="position: relative; display: inline-block; width: 100%;">
            <input type="date" id="deadline" name="deadline" value="{{ state.deadline }}" required
                title="Wybierz datę zakończenia zbierania zapotrzebowania">
            <div class="invalid-feedback"
                style="left: 100%; top: 0; margin-left: 10px; margin-top: 0; width: max-content;">
                Wybierz datę zakończenia zbierania zapotrzebowania
            </div>
        </div>
        <button type="submit" name="action" value="start">Rozpocznij planowanie</button>
    </form>

    {% elif state.status == PlanningStatus.IN_PROGRESS %}
    <div class="grid">
        <div>
            <strong style="color: rgb(4, 4, 204); display: inline-flex; align-items: center; gap: 0.5rem;">
                {{ icons.icon_planning_in_progress() }}
                PLANOWANIE W TOKU
            </strong>
            <p>Termin: <strong>{{ state.deadline if state.deadline else 'Nie ustawiono' }}</strong></p>
        </div>
        <form method="POST">
            <button type="submit" role="accept" name="action" value="submit_minister" class="primary">Przekaż do
                Ministerstwa</button>
        </form>
    </div>
    {% elif state.status == PlanningStatus.IN_REVIEW %}
    <strong style="color: #d4ac0d; display: inline-flex; align-items: center; gap: 0.5rem;">
        {{ icons.icon_planning_in_review() }}
        W PRZEGLĄDZIE W MINISTERSTWIE
    </strong>
    {% elif state.status == PlanningStatus.NEEDS_CORRECTION %}
    <strong style="color: orange; display: inline-flex; align-items: center; gap: 0.5rem;">
        {{ icons.icon_planning_needs_correction() }}
        POTRZEBA KOREKTY
    </strong>
    <hr />
    <form method="POST" class="grid needs-validation" novalidate>
        <label for="deadline">Ustaw termin <span style="color: red;">*</span></label>
        <div style="position: relative; display: inline-block; width: 100%;">
            <input type="date" id="deadline" name="deadline" value="{{ state.deadline }}" required
                title="Wybierz datę zakończenia zbierania zapotrzebowania">
            <div class="invalid-feedback"
                style="left: 100%; top: 0; margin-left: 10px; margin-top: 0; width: max-content;">
                Wybierz datę zakończenia zbierania zapotrzebowania
            </div>
        </div>
        <button type="submit" name="action" value="start">Wznów planowanie</button>
    </form>
    {% elif state.status == PlanningStatus.FINISHED%}
    <div class="grid">
        <div>
            <strong style="color: green; display: inline-flex; align-items: center; gap: 0.5rem;">
                {{ icons.icon_planning_finished() }}
                PLANOWANIE ZAKOŃCZONE
            </strong>
        </div>
        <form method="POST">
            <button type="submit" name="action" value="reopen" class="primary">Nowe planowanie</button>
        </form>
    </div>
    {% endif %}

    {% if state.correction_comment %}
    <p>
        <strong>Komentarz od Ministra:</strong>
        <span style="font-style: italic;">{{ state.correction_comment }}</span>
    </p>
    {% endif %}
</article>

<article>
    <header>Status Biur</header>
    <table role="grid">
        <thead>
            <tr>
                <th scope="col">Jednostka</th>
                <th scope="col">Status</th>
                <th scope="col">Liczba zadań</th>
                <th scope="col">Suma potrzeb (tys. zł)</th>
                <th scope="col"></th>
            </tr>
        </thead>
        <tbody>
            {% for office in offices_status %}
            <tr>
                <td>{{ office.name }}</td>
                <td>
                    {% if office.status == 'Submitted' %}
                    <strong style="color: green; display: inline-flex; align-items: center; gap: 0.5rem;">
                        {{ icons.icon_office_submitted() }}
                        Zatwierdzony
                    </strong>
                    {% else %}
                    <strong style="color: orange; display: inline-flex; align-items: center; gap: 0.5rem;">
                        {{ icons.icon_office_in_progress() }}
                        W trakcie
                    </strong>
                    {% endif %}
                </td>
                <td>{{ office.task_count }}</td>
                <td>{{ office.total_needs }}</td>
                <td>
                    <button class="show-office-details outline" office-name="{{ office.name }}">Pokaż szczegóły</button>
                </td>
            </tr>
            <tr id="details-{{ office.name }}" style="display: none;" class="expense-details">
                <td colspan="5">
                    {% if office.expenses %}
                    <div
                        style="overflow-x: auto; overflow-y: visible; scrollbar-width: auto; scrollbar-color: #888 #f1f1f1;">
                        <style>
                            /* Column width constraints for details table */
                            .details-table {
                                border-collapse: collapse;
                            }

                            .details-table th,
                            .details-table td {
                                border: 1px solid #ddd;
                                padding: 8px;
                            }

                            .details-table th {
                                background-color: #f5f5f5;
                                font-weight: bold;
                                border-bottom: 2px solid #888;
                            }

                            .details-table td:nth-child(1),
                            .details-table th:nth-child(1) {
                                /* Rozdział */
                                min-width: 80px;
                                max-width: 100px;
                            }

                            .details-table td:nth-child(2),
                            .details-table th:nth-child(2) {
                                /* Departament */
                                min-width: 100px;
                                max-width: 120px;
                            }

                            .details-table td:nth-child(3),
                            .details-table th:nth-child(3) {
                                /* Nazwa zadania */
                                min-width: 200px;
                                max-width: 300px;
                                white-space: normal;
                                word-wrap: break-word;
                            }

                            .details-table td:nth-child(4),
                            .details-table th:nth-child(4) {
                                /* Opis projektu */
                                min-width: 200px;
                                max-width: 300px;
                                white-space: normal;
                                word-wrap: break-word;
                            }

                            .details-table td:nth-child(5),
                            .details-table th:nth-child(5) {
                                /* Termin realizacji */
                                min-width: 120px;
                                max-width: 150px;
                            }

                            .details-table td:nth-child(6),
                            .details-table th:nth-child(6),
                            .details-table td:nth-child(7),
                            .details-table th:nth-child(7),
                            .details-table td:nth-child(8),
                            .details-table th:nth-child(8),
                            .details-table td:nth-child(9),
                            .details-table th:nth-child(9),
                            .details-table td:nth-child(10),
                            .details-table th:nth-child(10) {
                                /* Budget years */
                                min-width: 80px;
                                max-width: 100px;
                                text-align: right;
                            }

                            .details-table td:nth-child(11),
                            .details-table th:nth-child(11) {
                                /* Nr umowy */
                                min-width: 120px;
                                max-width: 150px;
                            }

                            .details-table td:nth-child(12),
                            .details-table th:nth-child(12) {
                                /* Z kim zawarta */
                                min-width: 150px;
                                max-width: 200px;
                                white-space: normal;
                                word-wrap: break-word;
                            }
                        </style>
                        <table role="grid" class="details-table">
                            <thead>
                                <tr>
                                    <th scope="col">Rozdział</th>
                                    <th scope="col">Departament</th>
                                    <th scope="col">Nazwa zadania</th>
                                    <th scope="col">Opis projektu</th>
                                    <th scope="col">Termin realizacji</th>
                                    <th scope="col">2025</th>
                                    <th scope="col">2026</th>
                                    <th scope="col">2027</th>
                                    <th scope="col">2028</th>
                                    <th scope="col">2029</th>
                                    <th scope="col">Nr umowy</th>
                                    <th scope="col">Z kim zawarta</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in office.expenses %}
                                <tr>
                                    <td>{{ expense.chapter }}</td>
                                    <td>{{ expense.departament or '-' }}</td>
                                    <td>{{ expense.task_name }}</td>
                                    <td>{{ expense.opis_projektu or '-' }}</td>
                                    <td>{{ expense.termin_realizacji or '-' }}</td>
                                    <td>{{ expense.budget_2025 or '-' }}</td>
                                    <td>{{ expense.budget_2026 or '-' }}</td>
                                    <td>{{ expense.budget_2027 or '-' }}</td>
                                    <td>{{ expense.budget_2028 or '-' }}</td>
                                    <td>{{ expense.budget_2029 or '-' }}</td>
                                    <td>{{ expense.nr_umowy or '-' }}</td>
                                    <td>{{ expense.z_kim_zawarta or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p>Brak wydatków.</p>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <th scope="row" colspan="3">Suma całkowita</th>
                <td><strong>{{ total_all_needs }} tys. zł</strong></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</article>

<article>
    <header>Import z pliku</header>
    <form action="/file_import" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        <fieldset {% if state.status !=PlanningStatus.IN_PROGRESS %}disabled{% endif %}
            style="border: none; padding: 0; margin: 0;">
            <div class="grid">
                <div class="file-input-wrapper"
                    style="display: flex; align-items: center; gap: 1rem; position: relative;">
                    <input type="file" id="file-upload" name="file" required class="file-input"
                        title="Wybierz plik do importu"
                        onchange="document.getElementById('file-name').textContent = this.files[0] ? this.files[0].name : 'Brak wybranego pliku'"
                        style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;">
                    <label for="file-upload" class="secondary" role="button" style="margin-bottom: 0;">Wybierz
                        plik</label>
                    <span id="file-name" style="font-style: italic;">Brak wybranego pliku</span>
                    <div class="invalid-feedback" style="top: 100%; margin-top: 0.5rem;">
                        Wybierz plik do importu
                    </div>
                </div>
                <button type="submit" class="secondary">Pobierz dane z pliku</button>
            </div>
        </fieldset>
    </form>
</article>

{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pl.js"></script>
<script>
    flatpickr("#deadline", {
        locale: "pl",
        altInput: true,
        altFormat: "d/m/Y",
        dateFormat: "Y-m-d",
        allowInput: true,
        altInputClass: "date-input",
        onReady: function (selectedDates, dateStr, instance) {
            instance.altInput.placeholder = "dd/mm/rrrr";
        }
    });
</script>
{% endblock %}